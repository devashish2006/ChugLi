name: Deploy NestJS Backend

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build application
        run: npm run build
      
      - name: Verify build output
        run: |
          echo "=== Checking build output ==="
          ls -la dist/
          echo ""
          echo "=== Contents of dist/src folder ==="
          ls -la dist/src/
          echo ""
          if [ -f "dist/src/main.js" ]; then
            echo "✅ dist/src/main.js found!"
          else
            echo "❌ ERROR: dist/src/main.js not found!"
            exit 1
          fi
      
      - name: Create deployment artifact
        run: |
          echo "=== Creating deployment package ==="
          mkdir -p deploy
          
          # Copy the entire dist folder
          cp -r dist deploy/
          
          # Copy package files
          cp package.json deploy/
          cp package-lock.json deploy/
          
          # Copy startup script
          cp startup.sh deploy/
          chmod +x deploy/startup.sh
          
          # Copy deployment config files
          if [ -f ".deployment" ]; then
            cp .deployment deploy/
          fi
          if [ -d ".azure" ]; then
            cp -r .azure deploy/
          fi
          
          # Install production dependencies in deploy folder
          cd deploy
          echo "=== Installing production dependencies ==="
          npm ci --omit=dev
          
          # Verify critical dependencies
          echo "=== Verifying @nestjs/schedule installation ==="
          if node -e "require('@nestjs/schedule')" 2>/dev/null; then
            echo "✅ @nestjs/schedule is installed"
          else
            echo "❌ ERROR: @nestjs/schedule missing!"
            exit 1
          fi
          
          # Create zip
          zip -r ../deploy.zip .
          
          echo "=== Deployment package created ==="
          cd ..
          ls -lh deploy.zip
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_3DCD60BA58CE40CEB593E51A31197DD4 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_50B82BF41E3E4074814877F179B68674 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_D23C57B71C054CE18D75C000985B1B3B }}
      
      - name: Configure Azure App Settings
        run: |
          az webapp config set \
            --name radis-backend \
            --resource-group radis-rg \
            --startup-file "bash startup.sh"
          
          az webapp config appsettings set \
            --name radis-backend \
            --resource-group radis-rg \
            --settings \
              SCM_DO_BUILD_DURING_DEPLOYMENT=false \
              ENABLE_ORYX_BUILD=false
      
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'radis-backend'
          package: deploy.zip
